<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gen's Matcha üçµ‚ú®</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fffaf6; --card:#fff; --ink:#2f2a2a; --muted:#7c6f6a;
      --pastel-1:#b7e4c7; --pastel-2:#ffd6e7; --pastel-3:#ffef9f; --pastel-4:#cde4ff;
      --accent:#7cc5b3; --shadow: 0 8px 24px rgb(0 0 0 / 7%); --radius:20px;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.5 "Fredoka","Comic Neue", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow-x:hidden;
    }
    .wrap{max-width:1100px; margin:auto; padding:28px}
    header{margin-bottom:20px; text-align:center}
    h1{font-size:28px; margin:0}

    .layout{display:grid; grid-template-columns:1fr 340px; gap:24px}
    @media (max-width:900px){ .layout{grid-template-columns:1fr} }

    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:20px}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      border:2px dashed #efefef;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .img{
      width:100%; aspect-ratio:1/1; object-fit:cover; display:block;
      border-radius:16px; margin-bottom:10px; border:2px solid #f3eef1; background:#fff;
    }
    .title{font-size:18px; margin:6px 0 2px}
    .options{display:grid; gap:8px; margin:10px 0}
    .option{display:flex; align-items:center; gap:10px}
    .option input{accent-color: var(--accent)}
    button{appearance:none;border:0;border-radius:14px;padding:10px 14px;background:var(--accent); color:#073c33; font-weight:700; cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted)}

    .cart{position:sticky; top:14px; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .divider{height:1px; background:#eee; margin:12px 0}
    .item{display:grid; grid-template-columns:1fr auto; gap:6px; padding:8px 0}
    .addons{font-size:13px; color:var(--muted)}
    .qty{display:flex; align-items:center; gap:6px}
    .qty input{width:56px; padding:6px 8px; border-radius:10px; border:1px solid #eee}
    .small{font-size:12px}

    /* QR section */
    .qrWrap{
      display:none;
      background:linear-gradient(135deg, var(--pastel-3), var(--pastel-2));
      padding:14px; border-radius:16px; margin-top:16px;
      text-align:center;
    }
    .qrWrap img{
      max-width:260px; width:100%;
      border-radius:18px; border:4px solid #fff; box-shadow:var(--shadow)
    }

    /* Centered header + reference pill */
    .qrHeader{ text-align:center; margin-bottom:10px; }
    .qrHeader .title{ font-size:18px; margin:0 0 4px; }
    .qrHeader .hint{ font-size:12px; color:var(--muted); margin:0 0 8px; }
    .orderRefBlock{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid #eee; border-radius:999px;
      padding:6px 10px; font-size:14px;
    }
    .copyBtn{
      background: var(--accent); color:#073c33;
      border:0; border-radius:8px; padding:4px 8px; font-size:12px; font-weight:700; cursor:pointer
    }

    /* Telegram field */
    .teleGroup{
      background:#fff7f3;
      border:2px solid #f0e6df;
      padding:12px;
      border-radius:14px;
      margin:6px 0 12px;
    }
    .teleLabel{display:block; font-weight:700; margin-bottom:6px;}
    #teleHandle{
      width:100%; padding:14px 16px; font-size:18px; border-radius:12px;
      border:2px solid var(--accent); outline:none; background:#fff;
      box-shadow:0 0 0 4px rgb(124 197 179 / 18%);
    }
    #teleHandle:focus{ box-shadow:0 0 0 6px rgb(124 197 179 / 26%); }

    .pill{display:inline-block; padding:6px 10px; background:#fff; border-radius:999px; font-size:12px; border:1px solid #eee}
  </style>
</head>
<body>
  <div class="wrap">
    <header><h1>Gen's Matcha üçµ‚ú®</h1></header>

    <div class="layout">
      <main>
        <p class="muted">Choose your drink, customise your matcha, and sip something super cute</p>
        <div class="grid" id="productGrid"></div>
      </main>

      <aside class="cart" id="cart">
        <h3 style="margin:0 0 8px">Your Cart</h3>
        <div id="cartItems"></div>
        <div class="divider"></div>
        <div class="row"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
        <div class="row"><span>Total</span><strong id="total">$0.00</strong></div>
        <p class="small muted">Prices shown exclude delivery. Cart saves on this device.</p>
        <div class="divider"></div>

        <!-- Telegram handle (required BEFORE QR) -->
        <div class="teleGroup">
          <label class="teleLabel" for="teleHandle">Telegram Handle</label>
          <input type="text" id="teleHandle" placeholder="@yourhandle">
        </div>

        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button id="confirmBtn" style="background:var(--pastel-1)">Check Out</button>
          <button id="clearBtn" style="background:var(--pastel-2)">Clear cart</button>
        </div>

        <!-- QR + Step 2: proof lives here -->
        <div class="qrWrap" id="qrWrap">
          <div class="qrHeader">
            <div class="title"><strong>PayNow to complete your order</strong></div>
            <p class="hint">Enter this reference in your banking app:</p>
            <div class="orderRefBlock">
              <span id="orderRef">‚Äî</span>
              <button id="copyRef" class="copyBtn">Copy</button>
            </div>
          </div>

          <img id="paynowQR" src="paynow-qr.png" alt="PayNow QR">

          <p class="small muted" style="margin:8px 0 10px">
            Scan QR, pay the exact amount, and type the reference above in your banking app.
          </p>

          <div class="teleGroup" style="background:#fff; border-color:#eee; text-align:left">
            <label class="teleLabel" for="paymentProof">Step 2 ‚Äì Upload proof of payment (screenshot/photo)</label>
            <input type="file" id="paymentProof" name="proof" accept="image/*">
            <div id="proofPreview" class="small muted" style="margin-top:6px"></div>
            <div class="row" style="margin-top:10px">
              <button id="submitProofBtn" style="background:#cde4ff" disabled>Submit proof</button>
              <span id="submitStatus" class="small muted"></span>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
  // ============= CONFIG =============
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx40ByeF9Ou6KMRPmRaUbc1Aj7Ch6CRXcS-pp45Uv-zjYrDIU16ORBn_VTY4ghms4Z3wQ/exec';
  // ==================================

  const products = [
    { id: 'matcha-yuzu',   title: 'Matcha Yuzu Tonic',      img: 'img/matcha-yuzu.png',   basePrice: 5.0, addons: [ { id: 'marukyu', label: 'Marukyu Isuzu', price: 1.5 }, { id: 'aoarashi', label: 'Marukyu Aoarashi', price: 1.5 } ] },
    { id: 'matcha-rasp',   title: 'Matcha Raspberry Tonic', img: 'img/matcha-rasp.png',   basePrice: 5.0, addons: [ { id: 'marukyu', label: 'Marukyu Isuzu', price: 1.5 }, { id: 'aoarashi', label: 'Marukyu Aoarashi', price: 1.5 } ] },
    { id: 'matcha-latte',  title: 'Matcha Latte',           img: 'img/matcha-latte.png',  basePrice: 6.0, addons: [ { id: 'marukyu', label: 'Marukyu Isuzu', price: 1.5 }, { id: 'aoarashi', label: 'Marukyu Aoarashi', price: 1.5 }, { id: 'oat', label: 'Oatmilk', price: 0.5 } ] },
    { id: 'mango-matcha',  title: 'Mango Matcha Latte',     img: 'img/mango-matcha.png',  basePrice: 6.0, addons: [ { id: 'marukyu', label: 'Marukyu Isuzu', price: 1.5 }, { id: 'aoarashi', label: 'Marukyu Aoarashi', price: 1.5 }, { id: 'oat', label: 'Oatmilk', price: 0.5 } ] }
  ];

  // local cart utils
  const CART_KEY = 'whisk_matcha_cart_v1';
  const loadCart = () => JSON.parse(localStorage.getItem(CART_KEY) || '[]');
  const saveCart = (items) => localStorage.setItem(CART_KEY, JSON.stringify(items));
  let cart = loadCart();

  function money(n){ return '$' + (Math.round(n*100)/100).toFixed(2); }
  function itemPrice(p, chosen){
    const addSum = chosen.reduce((s,a)=> s + (a.price||0), 0);
    return p.basePrice + addSum;
  }

  function addToCart({productId, qty, chosen}){
    const p = products.find(x=>x.id===productId);
    if(!p) return;
    const key = productId + '::' + chosen.map(a=>a.id).sort().join('+');
    const title = p.title;
    const addonsLabel = chosen.length ? chosen.map(a=>a.label).join(', ') : 'No add-ons';
    const unitPrice = itemPrice(p, chosen);

    const existing = cart.find(x=>x.key===key);
    if(existing){ existing.qty += qty; }
    else { cart.push({ key, productId, title, addons: chosen, addonsLabel, unitPrice, qty }); }
    saveCart(cart); renderCart();
  }

  function removeItem(key){ cart = cart.filter(x=>x.key!==key); saveCart(cart); renderCart(); }
  function setQty(key, q){ const it = cart.find(x=>x.key===key); if(it){ it.qty = Math.max(1, q|0); saveCart(cart); renderCart(); } }

  function totals(){
    const sub = cart.reduce((s,x)=> s + x.unitPrice * x.qty, 0);
    const total = sub;
    return { sub, total };
  }

  // Build product cards
  const grid = document.getElementById('productGrid');
  products.forEach(p=>{
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <img class="img" src="${p.img}" alt="${p.title}" loading="lazy"/>
      <div class="title">${p.title}</div>
      <p class="muted small" style="margin:0">Choose add-ons:</p>
      <div class="options"></div>
      <div class="row" style="margin-top:8px; gap:10px; align-items:center">
        <div class="qty small">Qty <input type="number" min="1" value="1"></div>
        <strong class="livePrice">${money(p.basePrice)}</strong>
        <button>Add to Cart</button>
      </div>
    `;

    const $opts = card.querySelector('.options');
    p.addons.forEach(a=>{
      const line = document.createElement('label');
      line.className = 'option';
      line.innerHTML = `<input type="checkbox" data-id="${a.id}" data-price="${a.price}"> <span>${a.label} (+${money(a.price)})</span>`;
      $opts.appendChild(line);
    });

    const qty = card.querySelector('input[type="number"]');
    const live = card.querySelector('.livePrice');

    function updateLive(){
      const chosen = [...card.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>({ id: cb.dataset.id, label: cb.nextElementSibling.textContent.replace(/ \(.+\)/,''), price: parseFloat(cb.dataset.price) }));
      const price = itemPrice(p, chosen);
      live.textContent = money(price);
    }
    card.addEventListener('change', e=>{ if(e.target.type==='checkbox'){ updateLive(); } });
    updateLive();

    const btn = card.querySelector('button');
    btn.addEventListener('click', ()=>{
      const chosen = [...card.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>({ id: cb.dataset.id, label: cb.nextElementSibling.textContent.replace(/ \(.+\)/,''), price: parseFloat(cb.dataset.price) }));
      addToCart({ productId: p.id, qty: parseInt(qty.value||'1',10), chosen });
      btn.textContent = 'Added ‚úì'; setTimeout(()=> btn.textContent='Add to Cart', 900);
    });

    grid.appendChild(card);
  });

  // Cart render
  const $items = document.getElementById('cartItems');
  const $sub = document.getElementById('subtotal');
  const $tot = document.getElementById('total');

  function renderCart(){
    if(cart.length===0){
      $items.innerHTML = '<p class="muted">Your cart is empty.</p>';
      $sub.textContent = money(0); $tot.textContent = money(0);
      return;
    }
    $items.innerHTML = '';
    cart.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <div>
          <div><strong>${it.title}</strong></div>
          <div class="addons">${it.addonsLabel}</div>
          <div class="small muted">${money(it.unitPrice)} each</div>
        </div>
        <div style="text-align:right">
          <div class="qty small">Qty <input type="number" min="1" value="${it.qty}"></div>
          <div style="margin-top:6px"><button title="Remove" style="background:var(--pastel-2)">Remove</button></div>
        </div>`;
      const qtyInput = row.querySelector('input');
      const rm = row.querySelector('button');
      qtyInput.addEventListener('change', e=> setQty(it.key, parseInt(e.target.value||'1',10)) );
      rm.addEventListener('click', ()=> removeItem(it.key) );
      $items.appendChild(row);
    });
    const t = totals();
    $sub.textContent = money(t.sub);
    $tot.textContent = money(t.total);
  }
  renderCart();

  // ======== Step 1 button (show QR) ========
  const qrWrap     = document.getElementById('qrWrap');
  const confirmBtn = document.getElementById('confirmBtn');
  const clearBtn   = document.getElementById('clearBtn');
  const teleInput  = document.getElementById('teleHandle');

  const orderRefEl = document.getElementById('orderRef');
  const copyRefBtn = document.getElementById('copyRef');

  const proofInput   = document.getElementById('paymentProof');
  const proofPreview = document.getElementById('proofPreview');
  const submitBtn    = document.getElementById('submitProofBtn');
  const submitStatus = document.getElementById('submitStatus');

  // require Telegram handle to enable checkout
  function setCheckoutDisabled(){ confirmBtn.disabled = (teleInput.value.trim()===''); }
  teleInput.addEventListener('input', setCheckoutDisabled); setCheckoutDisabled();

  let pendingOrder = null; // snapshot of order at the time QR is shown

  confirmBtn.addEventListener('click', ()=>{
    if(cart.length===0){ alert('Cart is empty.'); return; }
    // create a persistent order snapshot for step 2
    const t = totals();
    const orderId = 'ORD-' + Date.now();
    pendingOrder = {
      order_id: orderId,
      telegram: teleInput.value.trim(),
      subtotal: t.sub,
      total: t.total,
      items: JSON.parse(JSON.stringify(cart)) // deep-ish copy
    };

    orderRefEl.textContent = orderId;
    qrWrap.style.display = 'block';
    confirmBtn.textContent = 'Step 1 done ‚úì';
    confirmBtn.disabled = true; // prevent creating multiple order IDs
  });

  copyRefBtn.addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(orderRefEl.textContent); copyRefBtn.textContent = 'Copied!'; setTimeout(()=>copyRefBtn.textContent='Copy', 900); } catch(e){}
  });

  clearBtn.addEventListener('click', ()=>{
    cart = []; saveCart(cart); renderCart(); qrWrap.style.display='none';
    confirmBtn.textContent='Check Out'; setCheckoutDisabled();
    pendingOrder = null;
    submitBtn.disabled = true; proofInput.value = ''; proofPreview.textContent = ''; submitStatus.textContent='';
  });

  // ============ Step 2: Upload =============
  proofInput.addEventListener('change', ()=>{
    const f = proofInput.files[0];
    proofPreview.textContent = f ? `Selected: ${f.name}` : '';
    submitBtn.disabled = !f;
  });

  // Convert file to base64 for Google Apps Script
  async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function uploadOrderWithProof(order, file){
    // Convert image to base64
    const base64 = await fileToBase64(file);
    
    const fd = new FormData();
    fd.append('action','submit_order');
    fd.append('order_id', order.order_id);
    fd.append('telegram', order.telegram);
    fd.append('subtotal', String(order.subtotal));
    fd.append('total', String(order.total));
    fd.append('items', JSON.stringify(order.items));
    fd.append('proof', base64); // Send as base64 string

    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: fd
    });
    return await res.json();
  }

  submitBtn.addEventListener('click', async ()=>{
    try {
      if(!pendingOrder){ alert('Please click Check Out first.'); return; }
      const f = proofInput.files[0];
      if(!f){ alert('Please select a screenshot.'); return; }
      submitBtn.disabled = true; submitStatus.textContent = 'Uploading‚Ä¶';
      const resp = await uploadOrderWithProof(pendingOrder, f);
      if(resp.ok){
        submitStatus.textContent = 'Submitted ‚úì';
        // clear local cart AFTER successful submission
        cart = []; saveCart(cart); renderCart();
      } else {
        submitStatus.textContent = 'Upload failed: ' + (resp.error || 'unknown error');
        submitBtn.disabled = false;
      }
    } catch(e){
      submitStatus.textContent = 'Network error: ' + e.message;
      submitBtn.disabled = false;
    }
  });
  </script>
</body>
</html>
