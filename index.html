<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gen's Matcha üçµ‚ú®</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fffaf6; --card:#fff; --ink:#2f2a2a; --muted:#7c6f6a;
      --pastel-1:#b7e4c7; --pastel-2:#ffd6e7; --pastel-3:#ffef9f; --pastel-4:#cde4ff;
      --accent:#7cc5b3; --shadow: 0 8px 24px rgb(0 0 0 / 7%); --radius:20px;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.5 "Fredoka","Comic Neue", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow-x:hidden;
    }
    .wrap{max-width:1100px; margin:auto; padding:28px}
    header{margin-bottom:32px; text-align:center}
    h1{
      font-size:42px; margin:0 0 8px; 
      background: linear-gradient(135deg, #7cc5b3, #5a9d8a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .tagline{
      font-size:18px; color:var(--muted); margin:0;
      font-weight:400;
    }

    .layout{display:grid; grid-template-columns:1fr 360px; gap:28px}
    @media (max-width:900px){ .layout{grid-template-columns:1fr} }

    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:24px}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      border:2px solid transparent;
      display:flex; flex-direction:column; justify-content:space-between;
      transition: all 0.3s ease;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:''; position:absolute; top:0; left:0; right:0;
      height:4px; background:linear-gradient(90deg, var(--pastel-1), var(--pastel-2), var(--pastel-3));
      opacity:0; transition:opacity 0.3s ease;
    }
    .card:hover{
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgb(0 0 0 / 12%);
      border-color: var(--accent);
    }
    .card:hover::before{ opacity:1; }
    
    .img{
      width:100%; aspect-ratio:1/1; object-fit:cover; display:block;
      border-radius:16px; margin-bottom:14px; border:3px solid #f8f4f1; background:#fff;
      transition: transform 0.3s ease;
    }
    .card:hover .img{ transform: scale(1.03); }
    
    .title{font-size:20px; margin:8px 0 4px; font-weight:600}
    .options{display:grid; gap:10px; margin:14px 0}
    .option{
      display:flex; align-items:center; gap:12px;
      padding:10px 12px; background:#fafafa; border-radius:12px;
      transition: all 0.2s ease;
      cursor:pointer;
    }
    .option:hover{ background:#f0f0f0; }
    .option input{accent-color: var(--accent); cursor:pointer}
    .option span{cursor:pointer; user-select:none}
    
    button{
      appearance:none;border:0;border-radius:14px;padding:12px 16px;
      background:var(--accent); color:#073c33; font-weight:700; cursor:pointer;
      transition: all 0.2s ease; font-size:15px;
    }
    button:hover:not(:disabled){
      background:#6ab5a3; transform:translateY(-1px);
      box-shadow: 0 4px 12px rgb(124 197 179 / 30%);
    }
    button:active:not(:disabled){ transform:translateY(0); }
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted)}

    .cart{
      position:sticky; top:14px; background:var(--card); 
      border-radius:var(--radius); box-shadow:var(--shadow); padding:20px;
      border:2px solid #f5f5f5;
    }
    .cart h3{
      margin:0 0 16px; font-size:22px; 
      display:flex; align-items:center; gap:8px;
    }
    .cart-badge{
      background:var(--accent); color:#073c33; 
      font-size:12px; padding:2px 8px; border-radius:999px;
      font-weight:700;
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .divider{height:1px; background:#eee; margin:16px 0}
    .item{
      display:grid; grid-template-columns:1fr auto; gap:10px; 
      padding:12px; background:#fafafa; border-radius:12px; margin-bottom:8px;
    }
    .addons{font-size:13px; color:var(--muted); margin-top:4px}
    .qty{display:flex; align-items:center; gap:8px; font-size:14px}
    .qty input{
      width:60px; padding:8px 10px; border-radius:10px; 
      border:2px solid #eee; text-align:center; font-weight:600;
      transition: border-color 0.2s ease;
    }
    .qty input:focus{
      outline:none; border-color:var(--accent);
      box-shadow: 0 0 0 3px rgb(124 197 179 / 15%);
    }
    .small{font-size:12px}
    .livePrice{
      color:var(--accent); font-size:20px;
      text-shadow: 0 1px 2px rgb(0 0 0 / 5%);
    }

    /* Empty cart state */
    .empty-cart{
      text-align:center; padding:32px 16px;
      color:var(--muted);
    }
    .empty-cart::before{
      content:'üõí'; font-size:48px; display:block; margin-bottom:12px;
      opacity:0.3;
    }

    /* QR section */
    .qrWrap{
      display:none;
      background:linear-gradient(135deg, #fff7f3, #fffaf6);
      padding:20px; border-radius:16px; margin-top:20px;
      text-align:center; border:2px solid #f5e6df;
    }
    .qrWrap img{
      max-width:260px; width:100%;
      border-radius:18px; border:4px solid #fff; box-shadow:var(--shadow);
      margin:12px 0;
    }

    .qrHeader{ text-align:center; margin-bottom:16px; }
    .qrHeader .title{ font-size:19px; margin:0 0 8px; color:var(--ink)}
    .qrHeader .hint{ font-size:13px; color:var(--muted); margin:0 0 12px; }
    .orderRefBlock{
      display:inline-flex; align-items:center; gap:10px;
      background:#fff; border:2px solid var(--accent); border-radius:999px;
      padding:8px 14px; font-size:15px; font-weight:600;
    }
    .copyBtn{
      background: var(--accent); color:#073c33;
      border:0; border-radius:8px; padding:6px 12px; font-size:13px; 
      font-weight:700; cursor:pointer;
      transition: all 0.2s ease;
    }
    .copyBtn:hover{ background:#6ab5a3; }

    /* Telegram field */
    .teleGroup{
      background:#fff;
      border:2px solid #e8e8e8;
      padding:16px;
      border-radius:14px;
      margin:6px 0 16px;
      transition: border-color 0.3s ease;
    }
    .teleGroup:focus-within{ border-color:var(--accent); }
    .teleLabel{display:block; font-weight:700; margin-bottom:8px; font-size:14px}
    #teleHandle{
      width:100%; padding:14px 16px; font-size:16px; border-radius:12px;
      border:2px solid #e8e8e8; outline:none; background:#fafafa;
      transition: all 0.2s ease; font-family:inherit;
    }
    #teleHandle:focus{ 
      background:#fff; border-color:var(--accent);
      box-shadow:0 0 0 4px rgb(124 197 179 / 15%); 
    }

    /* File input styling */
    input[type="file"]{
      width:100%; padding:12px; border:2px dashed #ddd; 
      border-radius:12px; cursor:pointer;
      transition: all 0.2s ease; background:#fafafa;
    }
    input[type="file"]:hover{ border-color:var(--accent); background:#fff; }

    /* Total section highlight */
    .total-section{
      background:linear-gradient(135deg, #f0faf7, #f5fcf9);
      padding:16px; border-radius:14px; margin:16px 0;
      border:2px solid var(--pastel-1);
    }
    .total-section .row{ font-size:18px; }
    .total-section strong{ color:var(--accent); font-size:24px; }

    /* Button group */
    .btn-group{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
      margin-top:16px;
    }
    
    /* Animations */
    @keyframes slideIn {
      from { opacity:0; transform:translateY(20px); }
      to { opacity:1; transform:translateY(0); }
    }
    .card{ animation: slideIn 0.4s ease backwards; }
    .card:nth-child(1){ animation-delay:0.05s; }
    .card:nth-child(2){ animation-delay:0.1s; }
    .card:nth-child(3){ animation-delay:0.15s; }
    .card:nth-child(4){ animation-delay:0.2s; }

    /* Success states */
    .success-text{ color:#2d8659; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Gen's Matcha üçµ‚ú®</h1>
      <p class="tagline">Handcrafted matcha drinks, made with love</p>
    </header>

    <div class="layout">
      <main>
        <div class="grid" id="productGrid"></div>
      </main>

      <aside class="cart" id="cart">
        <h3>Your Cart <span class="cart-badge" id="cartCount">0</span></h3>
        <div id="cartItems"></div>
        
        <div class="divider"></div>
        
        <div class="row"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
        <div class="total-section">
          <div class="row"><span>Total</span><strong id="total">$0.00</strong></div>
        </div>
        <p class="small muted">Prices exclude delivery. Cart saves locally.</p>
        
        <div class="divider"></div>

        <!-- Telegram handle -->
        <div class="teleGroup">
          <label class="teleLabel" for="teleHandle">üì± Telegram Handle (Required)</label>
          <input type="text" id="teleHandle" placeholder="@yourhandle">
        </div>

        <div class="btn-group">
          <button id="confirmBtn">Check Out</button>
          <button id="clearBtn" style="background:var(--pastel-2)">Clear Cart</button>
        </div>

        <!-- QR + Proof upload -->
        <div class="qrWrap" id="qrWrap">
          <div class="qrHeader">
            <div class="title"><strong>üí≥ PayNow to Complete Order</strong></div>
            <p class="hint">Enter this reference in your banking app:</p>
            <div class="orderRefBlock">
              <span id="orderRef">‚Äî</span>
              <button id="copyRef" class="copyBtn">Copy</button>
            </div>
          </div>

          <img id="paynowQR" src="paynow-qr.png" alt="PayNow QR">

          <p class="small muted" style="margin:12px 0">
            Scan QR, pay the exact amount shown, and include the reference above.
          </p>

          <div class="teleGroup" style="background:#fff; border-color:#eee; text-align:left">
            <label class="teleLabel" for="paymentProof">üì∏ Step 2 ‚Äî Upload Payment Proof</label>
            <input type="file" id="paymentProof" name="proof" accept="image/*">
            <div id="proofPreview" class="small muted" style="margin-top:8px"></div>
            <div class="row" style="margin-top:14px; flex-wrap:wrap">
              <button id="submitProofBtn" style="background:#cde4ff" disabled>Submit Proof</button>
              <span id="submitStatus" class="small"></span>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
  // ============= CONFIG =============
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwNv5Oqncmmpclz5NPik9ebKuL-xhSV411LH1MFxmqbWry9CWvpZse6yXDj7N6kHXLV/exec';
  // ==================================

  const products = [
    { id: 'matcha-yuzu',   title: 'Matcha Yuzu Tonic',      img: 'img/matcha-yuzu.png',   basePrice: 5.0, addons: [ { id: 'marukyu', label: 'Marukyu Isuzu', price: 1.5 }, { id: 'aoarashi', label: 'Marukyu Aoarashi', price: 1.5 } ] },
    { id: 'matcha-rasp',   title: 'Matcha Raspberry Tonic', img: 'img/matcha-rasp.png',   basePrice: 5.0, addons: [ { id: 'marukyu', label: 'Marukyu Isuzu', price: 1.5 }, { id: 'aoarashi', label: 'Marukyu Aoarashi', price: 1.5 } ] },
    { id: 'matcha-latte',  title: 'Matcha Latte',           img: 'img/matcha-latte.png',  basePrice: 6.0, addons: [ { id: 'marukyu', label: 'Marukyu Isuzu', price: 1.5 }, { id: 'aoarashi', label: 'Marukyu Aoarashi', price: 1.5 }, { id: 'oat', label: 'Oatmilk', price: 0.5 } ] },
    { id: 'mango-matcha',  title: 'Mango Matcha Latte',     img: 'img/mango-matcha.png',  basePrice: 6.0, addons: [ { id: 'marukyu', label: 'Marukyu Isuzu', price: 1.5 }, { id: 'aoarashi', label: 'Marukyu Aoarashi', price: 1.5 }, { id: 'oat', label: 'Oatmilk', price: 0.5 } ] }
  ];

  // local cart utils
  const CART_KEY = 'whisk_matcha_cart_v1';
  const loadCart = () => JSON.parse(localStorage.getItem(CART_KEY) || '[]');
  const saveCart = (items) => localStorage.setItem(CART_KEY, JSON.stringify(items));
  let cart = loadCart();

  function money(n){ return '$' + (Math.round(n*100)/100).toFixed(2); }
  function itemPrice(p, chosen){
    const addSum = chosen.reduce((s,a)=> s + (a.price||0), 0);
    return p.basePrice + addSum;
  }

  function addToCart({productId, qty, chosen}){
    const p = products.find(x=>x.id===productId);
    if(!p) return;
    const key = productId + '::' + chosen.map(a=>a.id).sort().join('+');
    const title = p.title;
    const addonsLabel = chosen.length ? chosen.map(a=>a.label).join(', ') : 'No add-ons';
    const unitPrice = itemPrice(p, chosen);

    const existing = cart.find(x=>x.key===key);
    if(existing){ existing.qty += qty; }
    else { cart.push({ key, productId, title, addons: chosen, addonsLabel, unitPrice, qty }); }
    saveCart(cart); renderCart();
  }

  function removeItem(key){ cart = cart.filter(x=>x.key!==key); saveCart(cart); renderCart(); }
  function setQty(key, q){ const it = cart.find(x=>x.key===key); if(it){ it.qty = Math.max(1, q|0); saveCart(cart); renderCart(); } }

  function totals(){
    const sub = cart.reduce((s,x)=> s + x.unitPrice * x.qty, 0);
    const total = sub;
    return { sub, total };
  }

  // Build product cards
  const grid = document.getElementById('productGrid');
  products.forEach(p=>{
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <img class="img" src="${p.img}" alt="${p.title}" loading="lazy"/>
      <div class="title">${p.title}</div>
      <p class="muted small" style="margin:8px 0 4px">Customize your drink:</p>
      <div class="options"></div>
      <div class="row" style="margin-top:12px; gap:12px; align-items:center; flex-wrap:wrap">
        <div class="qty small">Qty <input type="number" min="1" value="1"></div>
        <strong class="livePrice">${money(p.basePrice)}</strong>
        <button style="flex:1; min-width:120px">Add to Cart</button>
      </div>
    `;

    const $opts = card.querySelector('.options');
    p.addons.forEach(a=>{
      const line = document.createElement('label');
      line.className = 'option';
      line.innerHTML = `<input type="checkbox" data-id="${a.id}" data-price="${a.price}"> <span>${a.label} (+${money(a.price)})</span>`;
      $opts.appendChild(line);
    });

    const qty = card.querySelector('input[type="number"]');
    const live = card.querySelector('.livePrice');

    function updateLive(){
      const chosen = [...card.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>({ id: cb.dataset.id, label: cb.nextElementSibling.textContent.replace(/ \(.+\)/,''), price: parseFloat(cb.dataset.price) }));
      const price = itemPrice(p, chosen);
      live.textContent = money(price);
    }
    card.addEventListener('change', e=>{ if(e.target.type==='checkbox'){ updateLive(); } });
    updateLive();

    const btn = card.querySelector('button');
    btn.addEventListener('click', ()=>{
      const chosen = [...card.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>({ id: cb.dataset.id, label: cb.nextElementSibling.textContent.replace(/ \(.+\)/,''), price: parseFloat(cb.dataset.price) }));
      addToCart({ productId: p.id, qty: parseInt(qty.value||'1',10), chosen });
      btn.textContent = 'Added ‚úì'; 
      
      // Reset the card after successful add
      setTimeout(()=> {
        btn.textContent='Add to Cart';
        // Uncheck all addons
        card.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
        // Reset quantity to 1
        qty.value = '1';
        // Update price display
        updateLive();
      }, 900);
    });

    grid.appendChild(card);
  });

  // Cart render
  const $items = document.getElementById('cartItems');
  const $sub = document.getElementById('subtotal');
  const $tot = document.getElementById('total');
  const $count = document.getElementById('cartCount');

  function renderCart(){
    const totalItems = cart.reduce((sum, it) => sum + it.qty, 0);
    $count.textContent = totalItems;
    
    if(cart.length===0){
      $items.innerHTML = '<div class="empty-cart"><p class="muted">Your cart is empty</p></div>';
      $sub.textContent = money(0); $tot.textContent = money(0);
      return;
    }
    $items.innerHTML = '';
    cart.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <div>
          <div><strong>${it.title}</strong></div>
          <div class="addons">${it.addonsLabel}</div>
          <div class="small muted">${money(it.unitPrice)} each</div>
        </div>
        <div style="text-align:right">
          <div class="qty small">Qty <input type="number" min="1" value="${it.qty}"></div>
          <div style="margin-top:8px"><button title="Remove" style="background:var(--pastel-2); padding:6px 12px; font-size:13px">Remove</button></div>
        </div>`;
      const qtyInput = row.querySelector('input');
      const rm = row.querySelector('button');
      qtyInput.addEventListener('change', e=> setQty(it.key, parseInt(e.target.value||'1',10)) );
      rm.addEventListener('click', ()=> removeItem(it.key) );
      $items.appendChild(row);
    });
    const t = totals();
    $sub.textContent = money(t.sub);
    $tot.textContent = money(t.total);
  }
  renderCart();

  // ======== Step 1 button (show QR) ========
  const qrWrap     = document.getElementById('qrWrap');
  const confirmBtn = document.getElementById('confirmBtn');
  const clearBtn   = document.getElementById('clearBtn');
  const teleInput  = document.getElementById('teleHandle');

  const orderRefEl = document.getElementById('orderRef');
  const copyRefBtn = document.getElementById('copyRef');

  const proofInput   = document.getElementById('paymentProof');
  const proofPreview = document.getElementById('proofPreview');
  const submitBtn    = document.getElementById('submitProofBtn');
  const submitStatus = document.getElementById('submitStatus');

  // require Telegram handle to enable checkout
  function setCheckoutDisabled(){ confirmBtn.disabled = (teleInput.value.trim()===''); }
  teleInput.addEventListener('input', setCheckoutDisabled); setCheckoutDisabled();

  let pendingOrder = null;

  confirmBtn.addEventListener('click', ()=>{
    if(cart.length===0){ alert('Cart is empty.'); return; }
    const t = totals();
    const orderId = 'ORD-' + Date.now();
    pendingOrder = {
      order_id: orderId,
      telegram: teleInput.value.trim(),
      subtotal: t.sub,
      total: t.total,
      items: JSON.parse(JSON.stringify(cart))
    };

    orderRefEl.textContent = orderId;
    qrWrap.style.display = 'block';
    confirmBtn.textContent = 'Step 1 Done ‚úì';
    confirmBtn.disabled = true;
  });

  copyRefBtn.addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(orderRefEl.textContent); copyRefBtn.textContent = 'Copied!'; setTimeout(()=>copyRefBtn.textContent='Copy', 900); } catch(e){}
  });

  clearBtn.addEventListener('click', ()=>{
    cart = []; saveCart(cart); renderCart(); qrWrap.style.display='none';
    confirmBtn.textContent='Check Out'; setCheckoutDisabled();
    pendingOrder = null;
    submitBtn.disabled = true; proofInput.value = ''; proofPreview.textContent = ''; submitStatus.textContent='';
  });

  // ============ Step 2: Upload =============
  proofInput.addEventListener('change', ()=>{
    const f = proofInput.files[0];
    proofPreview.textContent = f ? `Selected: ${f.name}` : '';
    submitBtn.disabled = !f;
  });

  async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function uploadOrderWithProof(order, file){
    const base64 = await fileToBase64(file);
    
    const payload = {
      action: 'submit_order',
      order_id: order.order_id,
      telegram: order.telegram,
      subtotal: String(order.subtotal),
      total: String(order.total),
      items: order.items,
      proof: base64
    };

    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    
    return { ok: true };
  }

  submitBtn.addEventListener('click', async ()=>{
    try {
      if(!pendingOrder){ alert('Please click Check Out first.'); return; }
      const f = proofInput.files[0];
      if(!f){ alert('Please select a screenshot.'); return; }
      submitBtn.disabled = true; submitStatus.textContent = 'Uploading‚Ä¶'; submitStatus.className = 'small muted';
      const resp = await uploadOrderWithProof(pendingOrder, f);
      if(resp.ok){
        submitStatus.textContent = 'Submitted ‚úì'; submitStatus.className = 'small success-text';
        cart = []; saveCart(cart); renderCart();
      } else {
        submitStatus.textContent = 'Upload failed: ' + (resp.error || 'unknown error');
        submitBtn.disabled = false;
      }
    } catch(e){
      submitStatus.textContent = 'Network error: ' + e.message;
      submitBtn.disabled = false;
    }
  });
  </script>
</body>
</html>
